Shift-JIS / JA16SJISTILDE 编码测试计划

 一、调研结论

 1.1 Shift-JIS 编码结构

 单字节范围:
 ┌───────────┬────────────────────────────────────────────┐
 │ 字节范围  │                    内容                    │
 ├───────────┼────────────────────────────────────────────┤
 │ 0x00-0x7F │ ASCII (注意: 0x5C=¥ 日元符, 0x7E=‾ 上划线) │
 ├───────────┼────────────────────────────────────────────┤
 │ 0xA1-0xDF │ 半角片假名 (63个字符)                      │
 └───────────┴────────────────────────────────────────────┘
 双字节范围:
 ┌───────────┬──────────────────────┬────────────────────────────────────┐
 │  首字节   │        次字节        │                内容                │
 ├───────────┼──────────────────────┼────────────────────────────────────┤
 │ 0x81-0x9F │ 0x40-0x7E, 0x80-0xFC │ 标点、符号、平假名、片假名、汉字等 │
 ├───────────┼──────────────────────┼────────────────────────────────────┤
 │ 0xE0-0xEF │ 0x40-0x7E, 0x80-0xFC │ 汉字续表                           │
 └───────────┴──────────────────────┴────────────────────────────────────┘
 1.2 JIS X 0208 区位结构
 ┌──────────┬─────────────────────────────────────┐
 │ 区 (Row) │                内容                 │
 ├──────────┼─────────────────────────────────────┤
 │ 1-2      │ 标点符号、特殊符号                  │
 ├──────────┼─────────────────────────────────────┤
 │ 3        │ 数字、拉丁字母                      │
 ├──────────┼─────────────────────────────────────┤
 │ 4        │ 平假名 (83字符)                     │
 ├──────────┼─────────────────────────────────────┤
 │ 5        │ 片假名 (86字符)                     │
 ├──────────┼─────────────────────────────────────┤
 │ 6        │ 希腊字母                            │
 ├──────────┼─────────────────────────────────────┤
 │ 7        │ 西里尔字母                          │
 ├──────────┼─────────────────────────────────────┤
 │ 8        │ 制表符                              │
 ├──────────┼─────────────────────────────────────┤
 │ 9-15     │ 保留未用                            │
 ├──────────┼─────────────────────────────────────┤
 │ 16-47    │ 第一水平汉字 (2,965字) - 按读音排序 │
 ├──────────┼─────────────────────────────────────┤
 │ 48-84    │ 第二水平汉字 (3,390字) - 按部首排序 │
 ├──────────┼─────────────────────────────────────┤
 │ 85-94    │ 未用                                │
 └──────────┴─────────────────────────────────────┘
 1.3 JA16SJISTILDE 与标准 Shift-JIS 的核心差异

 关键问题字符 (映射差异):
 ┌──────────────┬───────────┬───────────────────────────────┬─────────────────────────────────┐
 │ Shift-JIS 码 │   字符    │      标准映射 (JA16SJIS)      │  MS CP932 映射 (JA16SJISTILDE)  │
 ├──────────────┼───────────┼───────────────────────────────┼─────────────────────────────────┤
 │ 0x8160       │ 波浪线 ～ │ U+301C (WAVE DASH)            │ U+FF5E (FULLWIDTH TILDE)        │
 ├──────────────┼───────────┼───────────────────────────────┼─────────────────────────────────┤
 │ 0x8161       │ 双竖线 ‖  │ U+2016 (DOUBLE VERTICAL LINE) │ U+2225 (PARALLEL TO)            │
 ├──────────────┼───────────┼───────────────────────────────┼─────────────────────────────────┤
 │ 0x815C       │ 破折号 —  │ U+2015 (HORIZONTAL BAR)       │ U+2014 (EM DASH)                │
 ├──────────────┼───────────┼───────────────────────────────┼─────────────────────────────────┤
 │ 0x817C       │ 减号 −    │ U+2212 (MINUS SIGN)           │ U+FF0D (FULLWIDTH HYPHEN-MINUS) │
 ├──────────────┼───────────┼───────────────────────────────┼─────────────────────────────────┤
 │ 0x8191       │ 分币 ¢    │ U+00A2 (CENT SIGN)            │ U+FFE0 (FULLWIDTH CENT SIGN)    │
 ├──────────────┼───────────┼───────────────────────────────┼─────────────────────────────────┤
 │ 0x8192       │ 英镑 £    │ U+00A3 (POUND SIGN)           │ U+FFE1 (FULLWIDTH POUND SIGN)   │
 ├──────────────┼───────────┼───────────────────────────────┼─────────────────────────────────┤
 │ 0x81CA       │ 非号 ¬    │ U+00AC (NOT SIGN)             │ U+FFE2 (FULLWIDTH NOT SIGN)     │
 └──────────────┴───────────┴───────────────────────────────┴─────────────────────────────────┘
 单字节特殊字符:
 ┌──────┬─────────────────────┬──────────────────────┐
 │  码  │   标准 Shift-JIS    │    Windows CP932     │
 ├──────┼─────────────────────┼──────────────────────┤
 │ 0x5C │ ¥ (U+00A5 YEN SIGN) │ \ (U+005C BACKSLASH) │
 ├──────┼─────────────────────┼──────────────────────┤
 │ 0x7E │ ‾ (U+203E OVERLINE) │ ~ (U+007E TILDE)     │
 └──────┴─────────────────────┴──────────────────────┘
 ---
 二、测试数据设计

 2.1 测试数据分类 (全量测试)
 ┌────────────────┬──────────────────────────────────────────────┬────────────┬──────────────────────────────┐
 │      类别      │                Shift-JIS 范围                │ 测试点数量 │             说明             │
 ├────────────────┼──────────────────────────────────────────────┼────────────┼──────────────────────────────┤
 │ A. 问题字符    │ 0x815C, 0x8160-61, 0x817C, 0x8191-92, 0x81CA │ 7          │ 映射差异核心测试 (最重要)    │
 ├────────────────┼──────────────────────────────────────────────┼────────────┼──────────────────────────────┤
 │ B. 单字节特殊  │ 0x5C, 0x7E                                   │ 2          │ 反斜杠/日元、波浪线          │
 ├────────────────┼──────────────────────────────────────────────┼────────────┼──────────────────────────────┤
 │ C. ASCII       │ 0x20-0x7B, 0x7D                              │ ~90        │ 可打印ASCII (排除0x5C, 0x7E) │
 ├────────────────┼──────────────────────────────────────────────┼────────────┼──────────────────────────────┤
 │ D. 半角片假名  │ 0xA1-0xDF                                    │ 63         │ 半角假名全集                 │
 ├────────────────┼──────────────────────────────────────────────┼────────────┼──────────────────────────────┤
 │ E. 标点符号    │ 区1-2 (0x8140-824E)                          │ ~150       │ 全角标点、符号               │
 ├────────────────┼──────────────────────────────────────────────┼────────────┼──────────────────────────────┤
 │ F. 平假名      │ 区4 (0x829F-82F1)                            │ 83         │ 全量平假名                   │
 ├────────────────┼──────────────────────────────────────────────┼────────────┼──────────────────────────────┤
 │ G. 全角片假名  │ 区5 (0x8340-8396)                            │ 86         │ 全量片假名                   │
 ├────────────────┼──────────────────────────────────────────────┼────────────┼──────────────────────────────┤
 │ H. 一级汉字    │ 区16-47 (0x889F-9872)                        │ 2,965      │ 全量一级汉字                 │
 ├────────────────┼──────────────────────────────────────────────┼────────────┼──────────────────────────────┤
 │ I. 二级汉字    │ 区48-84 (0x989F-EAA4)                        │ 3,390      │ 全量二级汉字                 │
 ├────────────────┼──────────────────────────────────────────────┼────────────┼──────────────────────────────┤
 │ J. 希腊/西里尔 │ 区6-7                                        │ ~100       │ 希腊字母、西里尔字母         │
 ├────────────────┼──────────────────────────────────────────────┼────────────┼──────────────────────────────┤
 │ 总计           │                                              │ ~6,936     │ 完整字符集                   │
 └────────────────┴──────────────────────────────────────────────┴────────────┴──────────────────────────────┘
 2.2 测试数据格式

 CSV 格式: id, sjis_hex, char, utf8_hex, unicode_codepoint, category, description

 1,815C,—,E28094,U+2014,PROBLEM,"EM DASH (破折号)"
 2,8160,～,EFBD9E,U+FF5E,PROBLEM,"FULLWIDTH TILDE (波浪线)"
 ...

 ---
 三、实施步骤

 注意: 被测程序尚未开发完成。本计划先完成测试数据准备和验证网页生成，待程序开发完成后执行导出测试。

 步骤 1: 生成测试数据集

 脚本: generate_test_data.py

 输出文件:
 - test_data.csv - 主测试数据 (UTF-8 编码)
 - test_data_sjis.csv - Shift-JIS 编码版本 (用于 Oracle 导入)
 - expected_utf8.csv - 预期导出结果 (UTF-8)

 数据内容:
 id | sjis_hex | character | utf8_hex | unicode | category | description

 全量数据约 6,936 条记录，覆盖 JA16SJISTILDE 支持的所有字符。

 步骤 2: 生成静态验证网页

 文件 A: verify_utf8.html
 <!DOCTYPE html>
 <html>
 <head>
     <meta charset="UTF-8">
     <title>Shift-JIS Test Data - UTF-8 Verification</title>
 </head>
 <body>
     <h1>测试数据验证 (UTF-8)</h1>
     <table border="1">
         <tr><th>ID</th><th>SJIS Hex</th><th>字符</th><th>UTF-8 Hex</th><th>Unicode</th><th>类别</th></tr>
         <!-- 测试数据行 -->
     </table>
 </body>
 </html>
 - 编码: UTF-8 (with BOM 可选)
 - 用途: 在浏览器中验证 UTF-8 显示正确

 文件 B: verify_sjis.html
 <!DOCTYPE html>
 <html>
 <head>
     <meta charset="Shift_JIS">
     <title>Shift-JIS Test Data - SJIS Verification</title>
 </head>
 <body>
     <h1>テストデータ検証 (Shift_JIS)</h1>
     <table border="1">
         <tr><th>ID</th><th>SJIS Hex</th><th>文字</th><th>UTF-8 Hex</th><th>Unicode</th><th>カテゴリ</th></tr>
         <!-- 测试数据行 -->
     </table>
 </body>
 </html>
 - 编码: Shift-JIS
 - 文件实际编码必须为 Shift-JIS，不仅是 meta 声明
 - 用途: 验证 Shift-JIS 编码的数据正确

 手工验证方法:
 1. 用浏览器打开 verify_utf8.html (UTF-8)
 2. 用浏览器打开 verify_sjis.html (需确保浏览器以 Shift-JIS 解码)
 3. 对比两个页面：
   - 所有字符显示一致，无乱码 "?" 或 "�"
   - 特别关注 问题字符区域 (类别 A)
 4. 如发现乱码，检查数据生成逻辑

 步骤 3: Oracle 数据导入 (待程序开发完成后执行)

 前置条件: Oracle 数据库字符集为 JA16SJISTILDE

 SQL 脚本: create_test_table.sql
 -- 创建测试表
 CREATE TABLE sjis_test (
     id NUMBER PRIMARY KEY,
     sjis_hex VARCHAR2(20),
     char_data NVARCHAR2(10),  -- 使用 NVARCHAR2 存储 Unicode
     category VARCHAR2(50),
     description VARCHAR2(200)
 );

 SQL*Loader 控制文件: load_data.ctl
 LOAD DATA
 CHARACTERSET JA16SJISTILDE
 INFILE 'test_data_sjis.csv'
 INTO TABLE sjis_test
 FIELDS TERMINATED BY ','
 OPTIONALLY ENCLOSED BY '"'
 (id, sjis_hex, char_data, category, description)

 导入命令:
 # 设置 NLS_LANG
 export NLS_LANG=JAPANESE_JAPAN.JA16SJISTILDE

 # 执行导入
 sqlldr userid=user/pass control=load_data.ctl

 步骤 4: 执行导出测试 (待程序开发完成)

 # 使用被测程序从 Oracle 导出为 UTF-8 CSV
 # 具体命令待程序开发后确定
 ./export_tool --source-charset=JA16SJISTILDE --target-charset=UTF8 --output=exported.csv

 步骤 5: 结果验证

 对比脚本: verify_result.py
 #!/usr/bin/env python3
 # -*- coding: utf-8 -*-
 """
 验证导出结果是否与预期一致
 """
 import csv

 def verify_export(expected_file, actual_file):
     """
     对比预期结果与实际导出
     - id 必须匹配
     - char_data 的 UTF-8 字节序列必须完全一致
     - 输出差异报告
     """
     differences = []

     with open(expected_file, 'r', encoding='utf-8') as ef:
         with open(actual_file, 'r', encoding='utf-8') as af:
             expected = csv.DictReader(ef)
             actual = csv.DictReader(af)

             for exp_row, act_row in zip(expected, actual):
                 if exp_row['char_data'] != act_row['char_data']:
                     differences.append({
                         'id': exp_row['id'],
                         'expected': exp_row['char_data'].encode('utf-8').hex(),
                         'actual': act_row['char_data'].encode('utf-8').hex(),
                         'category': exp_row['category']
                     })

     return differences

 if __name__ == '__main__':
     diffs = verify_export('expected_utf8.csv', 'exported.csv')
     if diffs:
         print(f"发现 {len(diffs)} 处差异:")
         for d in diffs:
             print(f"  ID={d['id']} [{d['category']}]: expected={d['expected']}, actual={d['actual']}")
     else:
         print("验证通过! 所有字符转换正确。")

 ---
 四、预期测试结果

 4.1 问题字符的预期映射 (JA16SJISTILDE → UTF-8)
 ┌───────────┬──────┬─────────────────┬─────────┐
 │ Shift-JIS │ 字符 │ 预期 UTF-8 字节 │ Unicode │
 ├───────────┼──────┼─────────────────┼─────────┤
 │ 81 5C     │ —    │ E2 80 94        │ U+2014  │
 ├───────────┼──────┼─────────────────┼─────────┤
 │ 81 60     │ ～   │ EF BD 9E        │ U+FF5E  │
 ├───────────┼──────┼─────────────────┼─────────┤
 │ 81 61     │ ‖    │ E2 88 A5        │ U+2225  │
 ├───────────┼──────┼─────────────────┼─────────┤
 │ 81 7C     │ －   │ EF BC 8D        │ U+FF0D  │
 ├───────────┼──────┼─────────────────┼─────────┤
 │ 81 91     │ ￠   │ EF BF A0        │ U+FFE0  │
 ├───────────┼──────┼─────────────────┼─────────┤
 │ 81 92     │ ￡   │ EF BF A1        │ U+FFE1  │
 ├───────────┼──────┼─────────────────┼─────────┤
 │ 81 CA     │ ￢   │ EF BF A2        │ U+FFE2  │
 └───────────┴──────┴─────────────────┴─────────┘
 4.2 验证要点

 1. 问题字符: 确认使用 CP932/JA16SJISTILDE 映射而非标准 JIS 映射
 2. 往返一致性: Shift-JIS → UTF-8 → Shift-JIS 应保持不变
 3. 边界字符: 各区段首尾字符正确编码
 4. 汉字覆盖: 一级/二级汉字样本无损转换

 ---
 五、文件清单

 第一阶段 (现在生成)
 ┌───────────────────────┬─────────────────────────┬───────────┐
 │        文件名         │          用途           │   编码    │
 ├───────────────────────┼─────────────────────────┼───────────┤
 │ generate_test_data.py │ 测试数据生成脚本        │ UTF-8     │
 ├───────────────────────┼─────────────────────────┼───────────┤
 │ test_data.csv         │ 主测试数据集 (~6,936行) │ UTF-8     │
 ├───────────────────────┼─────────────────────────┼───────────┤
 │ test_data_sjis.csv    │ Shift-JIS 版测试数据    │ Shift-JIS │
 ├───────────────────────┼─────────────────────────┼───────────┤
 │ verify_utf8.html      │ UTF-8 验证网页          │ UTF-8     │
 ├───────────────────────┼─────────────────────────┼───────────┤
 │ verify_sjis.html      │ Shift-JIS 验证网页      │ Shift-JIS │
 ├───────────────────────┼─────────────────────────┼───────────┤
 │ expected_utf8.csv     │ 预期导出结果            │ UTF-8     │
 └───────────────────────┴─────────────────────────┴───────────┘
 第二阶段 (待程序开发后使用)
 ┌───────────────────────┬─────────────────────┬───────┐
 │        文件名         │        用途         │ 编码  │
 ├───────────────────────┼─────────────────────┼───────┤
 │ create_test_table.sql │ Oracle 建表脚本     │ -     │
 ├───────────────────────┼─────────────────────┼───────┤
 │ load_data.ctl         │ SQL*Loader 控制文件 │ -     │
 ├───────────────────────┼─────────────────────┼───────┤
 │ verify_result.py      │ 结果对比脚本        │ UTF-8 │
 └───────────────────────┴─────────────────────┴───────┘
 ---
 六、执行检查清单

 第一阶段: 测试数据准备 (现在执行)

 - 编写 generate_test_data.py 脚本
 - 生成 test_data.csv (UTF-8)，包含全量 ~6,936 个字符
 - 生成 test_data_sjis.csv (Shift-JIS)
 - 生成 verify_utf8.html 静态网页
 - 生成 verify_sjis.html 静态网页
 - 手工验证: 浏览器打开两个网页，确认无乱码
 - 特别检查问题字符 (0x815C, 0x8160, 0x8161, 0x817C, 0x8191, 0x8192, 0x81CA)
 - 生成 expected_utf8.csv (预期导出结果)

 第二阶段: Oracle 导入测试 (待程序开发后)

 - 确认 Oracle 数据库字符集为 JA16SJISTILDE
 - 创建测试表
 - 导入测试数据
 - 验证 Oracle 中数据存储正确

 第三阶段: 导出验证 (待程序开发后)

 - 执行被测程序导出 UTF-8 CSV
 - 运行 verify_result.py 对比结果
 - 记录并分析差异
 - 编写测试报告


-----------
JA16SJISTILDE 和普通 Shift-JIS 的字符集合差异

⏺ 简答：字符集合相同，只有 Unicode 映射不同。

  JA16SJISTILDE (等同于 Windows CP932) 和标准 Shift-JIS 包含完全相同的字符，区别仅在于这 9 个字符转换到 Unicode 时使用不同的码点：

  - 7 个双字节问题字符: 0x815C, 0x8160, 0x8161, 0x817C, 0x8191, 0x8192, 0x81CA
  - 2 个单字节特殊字符: 0x5C (反斜杠/日元), 0x7E (波浪/上划线)

  所以我们的测试数据集对两者都适用，只是预期的 UTF-8 输出不同。当前生成的数据是按 JA16SJISTILDE/CP932 映射的。


 ---
 参考资料

 - https://en.wikipedia.org/wiki/Shift_JIS
 - https://en.wikipedia.org/wiki/JIS_X_0208
 - https://docs.oracle.com/database/121/NLSPG/ch2charset.htm
 - https://github.com/ashtuchkin/iconv-lite/issues/145
 - https://www.fileformat.info/info/charset/Shift_JIS/list.htm